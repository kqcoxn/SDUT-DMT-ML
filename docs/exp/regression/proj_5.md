# 回归预测小项目实例五：股票价格走势预测

::: tip
**注意**：本参考思路为笔者小组完整作业，请勿直接挪用！

完整版代码将在课堂讲解后解锁。
:::

## 项目任务要求

任务描述：由于直接的经济利益，股票价格预测一直吸引着有兴趣投资股票市场和股票交易所的人。它也是金融界的一个重要研究课题。然而股票市场收益预测是一个非常复杂的问题，取决于公司财务状况和国家政策等诸多因素。

主要任务要求如下(不局限于以下要求)：

1. 可选用爬虫工具或其它方法制作数据集。
2. 建立股票价格趋势预测模型(至少两种不同回归方法分别建模，其中至少一种采用课外方法)。
3. 以预测精度来评估预测模型的拟合能力。
4. 结果分析。

## 数据集描述

为提高效率和及时性，本项目采用了知名的 yfinance 库（ranaroussi/yfinance (github.com)）对雅虎财经的数据进行获取。在此次研究中，我们以英伟达（NVIDIA）的股票价格走势为例，进行了股票价格的建模和模型评估。

确定英伟达数据集的爬取准确性：

![](<../images/regression/stock%20(1).png>)

确定是英伟达的信息无误后，本文选取近五年（2019.9.1-2024.9.1）的数据进行爬取，并输出部分数据观察特征属性：

![](<../images/regression/stock%20(2).png>)

获取到的数据为股票市场中经典的日交易数据，包括开盘价、最高价、最低价、收盘价、交易量、红利和股票分割信息。在实际应用中，人们最关注的往往是当天的收盘价，因为它能够较为直观地反映股票在特定交易日内的整体表现与历史趋势。且由于题目给出的主要任务是预测股价趋势，我们仅提取收盘价作为本文的主要分析对象。

为了方便后续的处理与分析，我们将必要的信息以及收盘价数据保存为 CSV 文件格式，以便进一步的数据处理与使用：

![](<../images/regression/stock%20(14).png>)

读入 csv 文件进行验证，并绘制折线图观察数据大致情况：

![](<../images/regression/stock%20(3).png>)

由图可以分析出，尽管在此之前由于疫情的影响，英伟达的收益曾有所下降，但近年来人工智能的迅猛发展显著提升了英伟达的利润。

## 主要算法原理及模型评价方法陈述

- 线性回归与岭回归的主要原理
- LSTM 回归的主要原理
- 均方误差（MSE）评价方法原理
- R2（决定系数）评价方法原理

详情略。

## 代码实现

### 数据集爬虫

代码如下：

::: info
**待实验点评结束后解锁**
:::

### 模型 1：基于平移对应的线性回归模型

本文首先采用参考文献中提出的方法（[基于线性回归的股票预测-CSDN 博客](https://blog.csdn.net/qq_42433311/article/details/121382417)）进行探索。然而，由于数据结构存在差异，方案并非完全依照该文献中的内容。

具体方案如下：

1. **数据读取与处理**：从 CSV 文件中读取英伟达股票数据，并将日期转换为适合时间序列分析的格式。设置日期为索引，以便于后续基于时间的处理。
2. **定义预测目标与平移数据**：以股票的收盘价作为预测目标，并设定未来的预测天数为数据总量的 n%。为实现未来预测，将数据框中的收盘价向前平移，以创建对应未来的标签值，标签值对应未来 m 天的收盘价，用于模型训练。
3. **特征预处理**：对收盘价进行标准化，以提升模型训练效果，并将数据拆分为用于训练模型的历史数据与用于预测未来的部分数据。
4. **数据集拆分**：将处理后的数据集拆分为训练集和测试集，比例为 8:2，以便评估模型性能。
5. **模型训练与预测**：使用线性回归模型对训练数据进行训练，生成拟合模型，进而利用训练好的模型对未来的股票收盘价进行预测。
6. **模型评价**：通过模型在测试集上的预测，计算并输出模型的准确性（R²），以衡量模型对测试数据的拟合程度。
7. **可视化**：绘制原始股票收盘价曲线与预测的未来收盘价曲线，以便直观比较模型的预测结果与实际历史数据。

代码如下：

::: info
**待实验点评结束后解锁**
:::

值得注意的是，进行股价预测的主要目的是寻找未来一段时间内最佳的购买（及时抄底最低价）与出售（及时在最高价时卖出）时机。因此，如果预测的时间过短，其实际应用价值将受到限制。尽管可以设定时间段，然而在一个时间段内实现稳定的预测结果更加重要。换言之，最好能够固定一个较长的时间段进行模型训练，以提高预测的有效性。

### 错误的想法：直接批量预测

在最初的设想中，本文考虑了直接进行强制划分与预测的可能性，相关结果见最后一部分。然而，这一模型的效果并不理想。

原因在于，线性回归的基本原理是对训练数据集进行拟合，并对未来数据集进行代数映射。如果仅依赖稳定时期的历史数据进行大规模预测，模型将无法有效预测突发的价格波动。

### 模型 2：基于特征提取、滑动窗口的岭回归模型

对于先前模型的不足之处，如何在保证模型适应性的同时，克服仅依赖稳定时期数据的局限性？

本文采用如下方案：在模型 1 的基础上，利用前 n 天的数据来预测下一天的值，并建立多组这样的映射关系，每一组映射对应自变量与未来 m 天之间的关系。整个过程类似于滑动窗口技术。同时，本文进一步挖掘时间特征，包括星期、季度和周期等，以发掘更多潜在的影响因素。鉴于维度的显著增加，此模型采用 L2 正则化的思路，即使用岭回归来替代线性回归作为模型。

除去上述变化外，总体建模思路与模型 1 基本一致，本文不再重复描述。

代码如下：

::: info
**待实验点评结束后解锁**
:::

### 模型 3：经典 LSTM 模型

除线性回归模型外，本文还探索了基于“时间记忆”的长短期记忆网络（LSTM）模型。LSTM 是一种特殊类型的循环神经网络，专门用于处理和预测序列数据。其通过引入记忆单元，解决了传统循环神经网络在长序列训练中遇到的梯度消失问题。LSTM 能够在较长时间跨度内保存信息，并在需要时选择性地读取、更新或遗忘这些信息。正因如此，LSTM 在处理时间序列数据和自然语言处理等任务时表现优异，能够捕捉数据中的长程依赖关系。

顾名思义，时序预测任务更加适合采用 LSTM 模型。长短期记忆网络作为一种具备强化记忆能力的循环神经网络（RNN）模型，对随时间变化的数据具有天然的拟合能力。

本文首先按照经典 LSTM 的思路进行了一次训练，具体过程如下：

1. **数据读取**：读取股票数据，并将日期设置为索引，选择"Close"列作为目标序列。
2. **数据预处理**：对"Close"列进行归一化处理。
3. **训练集与测试集划分**：将归一化后的数据按 9:1 的比例划分为训练集和测试集。
4. **生成序列数据**：将时间序列数据转换为输入序列和目标值，仍然采用滑动窗口的方式，即根据过去 n 天的价格预测下一天的价格。但与之前的步骤不同，本文分别对训练集和测试集生成滑动窗口序列数据，二者相互独立。
5. **定义 LSTM 模型**：采用经典的 LSTM 模型结构，包括一个 LSTM 层和一个全连接层。LSTM 层用于提取序列中的时间依赖性信息，全连接层则用于输出预测值。
6. **模型训练**：使用均方误差作为损失函数，并采用 Adam 优化器进行梯度更新。
7. **模型预测与可视化**：在测试集上进行预测，并将预测结果反归一化处理。最后，本文将实际股票价格与模型预测值通过绘图进行对比，以展示预测效果。

代码如下：

::: info
**待实验点评结束后解锁**
:::

## 运行结果与分析

### 线性回归模型

线性回归模型得到的结果如下：

![](<../images/regression/stock%20(4).png>)

可以看出，当预测天数为 13 天（占 1%）时，模型的评估表现较好，决定系数为 0.972，均方误差为 26.198，且在实际预测集中，均方误差能够达到 16。

![](<../images/regression/stock%20(10).png>)

可以多测试不同的预测天数，得到的部分结果如下：

![](<../images/regression/stock%20(5).png>)

![](<../images/regression/stock%20(6).png>)

![](<../images/regression/stock%20(7).png>)

![](<../images/regression/stock%20(8).png>)

在一定梯度的遍历下，可以发现，当预测天数越少时越准确。其原因可能有：

- 短期内数据的变化不会很大
- 短时间内出现突变点的概率较低
- 更多的跳变点被涵盖进来限制单向的变化

特别的，当参数偏离较佳配置时，实际预测的均方误差会成比例放大。

所以这个模型在做 13 天（两周）的预测表现尚好，其他的参数配置下误差开始逐渐增大。

### 错误的线性回归模型

错误的线性回归模型结果如下：

![](<../images/regression/stock%20(9).png>)

显而易见，该模型表现较差，其原因已在前文中进行了分析。此外，由于该模型并非本文设计的主要模型，因此不再过多论述。

### 特征提取、岭回归与滑动窗口

岭回归的最终模型效果如下：

![](<../images/regression/stock%20(12).png>)

在为期一年的预测过程中，模型的决定系数达到了 0.988，均方误差仅有 11，表现令人惊叹。分析其原因，滑动窗口的方法并未将整个数据集作为参数使用，而是基于一定窗口大小进行取值，并考虑了整个窗口内各数据点之间的对应关系。

该方法是否存在不足？答案是肯定的。模型对训练数据存在较高的依赖性，表明其具有潜在的过拟合风险。此外，模型的数据处理方式也存在一些问题。具体来说，在构建新模型时，由于滑动窗口大小的影响，部分数据既出现在训练集中，又出现在测试集中。然而，这一问题对实际预测过程的影响较小，因为在滑动到某一特定日期时，前 n 天的数据被视为已知信息，不影响后续预测步骤的准确性。

为了进一步验证模型的实际表现，可以模拟真实的预测场景。在进行下一时段预测时，需要获取最后 n 天的数据，并预测第 n+1 天的值。然后将第 n+1 天的数据作为下一次预测的前 n 天数据的最后一个数据点。然而，鉴于我们已无最新的测试数据，因此将原始数据划分为两部分，一部分用于训练模型，另一部分用于仿真预测，所得结果如下：

![](<../images/regression/stock%20(13).png>)

可以看出确实出现了过拟合现象，具体原因将在结果分析部分进行阐述。尽管如此，不得不提到这是一个“较优模型”，其能够很好地契合原数据集的趋势，并且完全满足了本次研究对于“模型拟合能力”的要求。然而，线性模型的局限性在于，它只能在原数据集的范围内表现出良好的拟合能力。

### LSTM 模型

经过调参，得到的较优参数与结果如下：

![](<../images/regression/stock%20(11).png>)

可以观察到，模型的均方误差可以拟合到 21，决定系数拟合到 0.92。模型基本上能够拟合真实情况，但其效果甚至不及 1.1 版本的线性回归模型。推测原因在于，针对深度学习模型，数据的维度过少，且股票的时间特征相较于突发事件的影响性较小，周期性特征亦并不明显。

此外，本研究仅实现了最基础的 LSTM 模型，实际上在调整 LSTM 层数、引入 Dropout 和 Batch Normalization、应用 Attention 机制、考虑残差连接、改变激活函数及学习率调度器等方面均可进行改进。然而，由于深度学习并非本次实验或本阶段学习的重点，加之近期小组成员时间有限，因此不再进行进一步的优化，仅提出上述思路。

### 模型对比与总结

对于构建的所有模型，建立如下表格进行对比：

| 模型               | 决定系数 | 均方误差 | 优点                                                                 | 缺点                                                                       | 适用场景                                                     |
| ------------------ | -------- | -------- | -------------------------------------------------------------------- | -------------------------------------------------------------------------- | ------------------------------------------------------------ |
| 线性回归模型       | 0.972    | ≈26      | - 短期预测准确性高                                                   | - 对参数敏感，偏离最佳配置时均方误差增大                                   | 短期预测，数据变化小的情况                                   |
| 错误的线性回归模型 | 未计算   | 未计算   | 无                                                                   | - 表现显著差，未达到设计目标                                               | 不推荐使用                                                   |
| 岭回归模型         | 0.988    | ≈11      | - 准确性高，拟合效果优越<br>- 考虑了数据点间的关系，减少了过拟合风险 | - 对训练数据依赖性高，存在潜在的过拟合风险<br>- 部分数据重叠影响模型可靠性 | 长期预测，尤其是时间序列数据                                 |
| LSTM 模型          | 0.92     | ≈21      | - 可以捕捉复杂的非线性关系<br>- 适合处理时间序列数据                 | - 在当前设置下效果不如线性回归<br>- 数据维度不足，可能导致模型性能下降     | 需要捕捉复杂模式或长期依赖的时间序列数据，并需要更复杂的调参 |

总结：

- 线性回归模型在短期预测中表现出色，但对于参数敏感。
- 错误的线性回归模型表现不佳，未达到设计目标。
- 岭回归模型使用滑动窗口方法取得了最佳表现，但存在过拟合风险。
- LSTM 模型虽然是深度学习模型，但在当前设置下未能优于线性模型，期待未来进一步优化。

### 项目总结与畅想

其实在做整个作业之前我们就在想，股票预测这个东西真的能在真实环境下生效吗？

显然是不可能的，这是经典的 P=NP 问题。我们只能尽可能的去拟合已知数据集，然后再在已知数据集的后面做一点短时间范围内的预测。

为什么？

以线性回归为例，线性回归表现最好的地方往往原始数据集与将要预测的数据都有一个“上下限”或者潜在的固定趋势。比如预测西瓜好坏，一个西瓜最大就那么大，最小就那么小；最重就那么重，最轻就那么轻，他们的对应关系也就是那样。也就是说，在一个有限的范围与有限的维度内，我们能得到的预测结果往往是比较好的。

但是股票预测就难在，他的时间是无限的，没有一个上限；他的维度是无限的，如果把所有突发事件或影响因子转化为独热编码，那编码的列也是几乎无限的；他的对应关系是无限的，我们永远不可能穷举出所有的现实情况。所以在这种情况下，我们很难用已有数据预测未知数据。

出于时间、设备等限制，其实我们小组在这个作业中只是对已有的数据做尽可能的分析与处理，尽可能的拟合了原始数据集，也就是把股票的上下限与维度限定在爬取数据的时间范围内。不过预测已有数据也需要很多的巧思，毕竟股票的变化曲线也是完全“凭心情”，这一点正是我们在本次实验中下功夫的地方。

在本次实验查找资料的过程中，我们也了解到非常多的研究都从围绕金融大数据分析与投资决策展开研究，从股价和趋势预测、优质股推荐、舆情分析、投资组合和应对突发事件等方面入手，尽可能的实现真实情况下的精准预测。希望有一天，通过我们的努力，我们未来的工作也能在真正的实际应用中大放异彩。
